<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8 />
		<title>レコメンダー</title>
		<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

		<!-- Leaflet.js -->
		<link rel="stylesheet" href="//unpkg.com/leaflet@1.0.0-rc.3/dist/leaflet.css" />
		<script src="//unpkg.com/leaflet@1.0.0-rc.3/dist/leaflet-src.js"></script>
		<script src="//unpkg.com/esri-leaflet@2.0.3"></script>

		<!-- jQuery -->
		<script src="//ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

		<!-- marker cluster -->
		<link rel="stylesheet" href="./lib/MarkerCluster/MarkerCluster.css" />
		<link rel="stylesheet" href="./lib/MarkerCluster/MarkerCluster.Default.css" />
		<script src="./lib/MarkerCluster/leaflet.markercluster.js"></script>

		<style>
			html, body, #mapDiv { height: 100%; width: 100%; margin:0; padding:0; }
			a { cursor: pointer; }
		</style>
	</head>
	<body>
		<div id="mapDiv"></div>

		<script>
			var marker, circle;

			var url = "//services5.arcgis.com/HzGpeRqGvs5TMkVr/arcgis/rest/services/aMHS_item_LID_12/FeatureServer/0";

			var params = {
				ageID: null,
				sexID: null,
				priceID: null,
				item_LID: null,
				aniversaryID: null,
				x: null,
				y: null,
				token: null
			}
			var urlParam = location.search.substring(1);
			if (urlParam) {
				var param = urlParam.split('&');
				for (i = 0; i < param.length; i++) {
					var paramItem = param[i].split('=');
					params[paramItem[0]] = paramItem[1];
				}
			}

			var map = L.map("mapDiv").setView([Number(params.y), Number(params.x)], 12);
			L.esri.basemapLayer("Topographic").addTo(map);

			var sql = getSql();

			function getSql(){
				var arry = [];
				if (params.ageID) {
					arry.push("ageID =" + params.ageID);
				}
				if (params.sexID) {
					arry.push("sexID =" + params.sexID);
				}
				if (params.priceID) {
					switch(params.priceID){
						case '1':
							arry.push("unit_price < " + 5000);
							break;
						case '2':
							arry.push("unit_price BETWEEN " + 5000 + " AND " + 10000);
							break;
						case '3':
							arry.push("unit_price BETWEEN 10000 AND 30000");
							break;
						case '4':
							arry.push("unit_price >= 30000");
					}
				}
				if (params.item_LID) {
					arry.push("item_LID =" + params.item_LID);
				}
				if (params.aniversaryID) {
					arry.push("aniversaryID =" + params.aniversaryID);
				}

				var sql = arry.join(' AND ');

				return sql;
			}

			L.esri.query({
				url: url
			}).token(params.token).where(sql).run(function(error, featureCollection){
				if (featureCollection) {
					if (featureCollection.features.length > 0) {
						var markers = L.markerClusterGroup();
						var geojson = L.geoJson(featureCollection, {
							onEachFeature: function(feature, layer){
								layer.bindPopup(feature.properties.shop_name);
							}
						});
						markers.addLayer(geojson);
						map.addLayer(markers);
					}
				} else {
					console.log(error);
				}
			});

			map.on('click', function(e){
				if (marker) {
					map.removeLayer(marker);
				}
				if (circle) {
					map.removeLayer(circle);
				}
				marker = L.marker(e.latlng).addTo(map);

				var link = $('<a>検索</a>').click(function(){
					circle = L.circle(e.latlng, 1000).addTo(map);

					var parameter = createParameter(e.latlng);
						var url = '//ejhack.github.io/listapp/test/index.html' + '?' + parameter;

						document.location.href = url;
				})[0];
				marker.bindPopup(link).openPopup();

				function createParameter(latlng){
					var parameter = url + '/query?returnGeometry=true&where=' + '1%3D1' + '&outSr=4326&outFields=*&token=' + params.token + '&geometry=' + latlng.lng + '%2C' + latlng.lat + '&geometryType=esriGeometryPoint&spatialRel=esriSpatialRelIntersects&units=esriSRUnit_Meter&distance=1000&inSr=4326&f=geojson';
					return parameter;
				}
			});
		</script>
	</body>
</html>